<script src="dist/webkey.umd.js"></script>
<script>
    var callAuthorize = function(commandParams, callback) {
        var height=600, width=500, left = (screen.width/2-width/2), top = (screen.height/2-height)
        var authorizeWindow = window.open('/authorize.html','webkeyWindow',
                "width="+width+",height="+height+",left="+left+",top="+top
        )

        // if the window's already open, these lines brings it to the front again with the proper size
        window.resizeTo(width,height)
        window.moveTo(left,top)
        authorizeWindow.focus()

        var authed = false
        authorizeWindow.onbeforeunload = function() {
            if(!authed) {
                callback(new Error("rejected"))
            }
        }

        window.addEventListener("message", function(message){
            if(message.origin !== document.location.origin) return // ignore

            var params = JSON.parse(message.data)
            if(params.response === undefined && params.ready === undefined) return // ignore things that aren't responses or ready messages

            if(params.response === commandParams.c) {
                callback(undefined, params.password)
                authed = true
                authorizeWindow.close()
            } else if(params.ready) {
                authorizeWindow.postMessage(JSON.stringify(commandParams), document.location.origin)
            }
        })
    }

    window.addEventListener("message", function(message) {
        webkey.commands.handle(message, function getAcceptance(callback) {
            callAuthorize({c:'getAcceptance', origin:message.origin}, callback)
        }, function getAcceptance(callback) {
            callAuthorize({c:'getPassword'}, callback)
        })
    })

    parent.postMessage(JSON.stringify({ready:true}), "*")
</script>